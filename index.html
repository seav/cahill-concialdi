<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cahillâ€“Concialdi Projection</title>
</head>
<style>

html, body {
  margin: 0;
  padding: 0;
  background: #000;
}

svg, canvas {
  position: absolute;
  width: 100vw;
}

</style>
<body>

<canvas></canvas>
<svg>
  <style>
#background {
  fill: #123;
  stroke: none;
}

#graticule {
  fill: none;
  stroke-width: 0.15;
  stroke: #246;
}

#circles {
  fill: none;
  stroke-width: 0.3;
  stroke: #357;
}

.polar-tropic {
  stroke-dasharray: 1 1;
}

#countries {
  stroke-width: 0.01;
  stroke-linejoin: round;
}

#countries path:hover {
  fill: #ff8;
}

#boundaries {
  fill: none;
  stroke: #234;
  stroke-width: 0.1;
  stroke-linejoin: round;
  stroke-linecap: round;
}

#boundaries path.disputed {
  stroke-dasharray: 0.5 0.2;
}
  </style>
  <g id="svg-map-wrapper">
    <path id="background" />
    <g id="graticule"></g>
    <g id="circles"></g>
    <g id="countries"></g>
    <g id="boundaries"></g>
  </g>
</svg>

<script src="https://unpkg.com/complex.js@2.0.11/complex.min.js"></script>
<script type="module">

import { drawVectorMap } from './map-vector.mjs';
import {
  drawRasterMap,
  RASTER_NE_I,
  RASTER_NE_HYPSO,
  RASTER_NASA_BLUE,
  RASTER_NASA_BLACK,
  RASTER_NE_I_DAY_NIGHT,
  RASTER_NE_HYPSO_DAY_NIGHT,
  RASTER_NASA_DAY_NIGHT,
} from './map-raster.mjs';

//drawVectorMap();

const ZOOM = 3;
const TILE_WIDTH = 512;
const FULL_WIDTH = TILE_WIDTH * (2**ZOOM);

const tiles = { light: [], dark: [] };
const sourceCanvas = document.createElement('canvas');
sourceCanvas.width = FULL_WIDTH * 2;
sourceCanvas.height = FULL_WIDTH;
const sourceContext = sourceCanvas.getContext('2d')

let numImagesLoaded = 0;

const onloadHandler = function() {

  numImagesLoaded++;
  if (numImagesLoaded < (2**ZOOM)**2 * 2) return;

  for   (let x = 0; x < 2**ZOOM; x++) {
    for (let y = 0; y < 2**ZOOM; y++) {
      sourceContext.drawImage(tiles.light[x][y], x * TILE_WIDTH             , y * TILE_WIDTH);
      sourceContext.drawImage(tiles.dark [x][y], x * TILE_WIDTH + FULL_WIDTH, y * TILE_WIDTH);
    }
  }
  drawRasterMap([
    sourceContext.getImageData(0         , 0, FULL_WIDTH, FULL_WIDTH).data,
    sourceContext.getImageData(FULL_WIDTH, 0, FULL_WIDTH, FULL_WIDTH).data,
  ]);
}

for (let x = 0; x < 2**ZOOM; x++) {
  tiles.light[x] = [];
  tiles.dark [x] = [];
  for (let y = 0; y < 2**ZOOM; y++) {
    const imageLight = new Image();
    imageLight.src = `https://cartodb-basemaps-a.global.ssl.fastly.net/rastertiles/voyager/${ZOOM}/${x}/${y}@2x.png`;
    imageLight.crossOrigin = 'anonymous';
    imageLight.onload = onloadHandler;
    tiles.light[x][y] = imageLight;

    const imageDark = new Image();
    imageDark.src = `https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/${ZOOM}/${x}/${y}@2x.png`;
    imageDark.crossOrigin = 'anonymous';
    imageDark.onload = onloadHandler;
    tiles.dark[x][y] = imageDark;
  }
}

</script>
</body>
</html>
